/* ========================================
 * JAVASCRIPT COMPLETO E CORRIGIDO
 * ========================================
 */
const API_KEY = "65e7972a036cf9f4506c1f837a38a9ae"; // Sua chave TMDB
const IMG_BASE = "https://image.tmdb.org/t/p/w500";

let activeProfile = null;
let categories = [];
let moviesByCategory = {};
let currentLanguage = "pt-BR";
let featuredIndex = 0;
let featuredInterval = null;
let featuredMoviesWithTrailers = [];
let isLoadingFeatured = false;

const movieCategories = [
    {id: 28, name: "Ação"},
    {id: 35, name: "Comédia"},
    {id: 18, name: "Drama"},
    {id: 10749, name: "Romance"},
    {id: 27, name: "Terror"},
    {id: 16, name: "Animação"},
    {id: 878, name: "Ficção Científica"},
    {id: 99, name: "Documentário"},
    {id: 12, name: "Aventura"},
    {id: 14, name: "Fantasia"},
    {id: 80, name: "Crime"},
    {id: 36, name: "História"},
    {id: 10751, name: "Família"},
    {id: 10402, name: "Música"},
    {id: 53, name: "Suspense"},
    {id: 10752, name: "Guerra"},
    {id: 37, name: "Faroeste"}
];

const profiles = {
    mirian:"https://i.postimg.cc/KvC37NYk/IMG20250801105332.jpg",
    sonia: "https://i.postimg.cc/SKy5gcTq/IMG20250801105254.jpg",
    requena: "https://i.postimg.cc/zXC88MgS/image.png",
    victoria: "https://i.postimg.cc/R0ZB8c98/victoria.jpg",
    isabela: "https://i.postimg.cc/Rq5C5jhZ/isabela.jpg",
    beatriz: "https://i.postimg.cc/2jGHK4qn/beatriz.jpg",
    pedro: "https://i.postimg.cc/xjxwbyT6/pedro.jpg",
    joao: "https://i.postimg.cc/wM6VRmRX/jo-o.jpg",
    kaylan: "https://i.postimg.cc/0yVR9jCF/kaylan.jpg",
    junior: "https://i.postimg.cc/YqxCrw8J/junior.jpg"
};

function mostrarPerfis() {
    const lista = document.getElementById("listaPerfis");
    lista.innerHTML = "";
    for(let name in profiles){
        const div = document.createElement("div");
        div.classList.add("perfil");
        div.innerHTML = `<img src="${profiles[name]}" /><span>${name}</span>`;
        div.onclick = () => selecionarPerfil(name);
        lista.appendChild(div);
    }
}

function selecionarPerfil(name){
    activeProfile = name;
    document.getElementById("avatarSidebar").src = profiles[name];
    document.getElementById("login").style.display = "none";
    document.getElementById("selecaoPerfis").style.display = "none";
    document.getElementById("catalogo").style.display = "block";
    loadCategories();
}

function fazerLogin(){
    const email = document.getElementById("email").value;
    const password = document.getElementById("senha").value;
    if(email && password){
        mostrarPerfis();
        document.getElementById("login").style.display = "none";
        document.getElementById("selecaoPerfis").style.display = "flex";
    }
}

function toggleSidebar(){
    document.getElementById("sidebar").classList.toggle("collapsed");
    document.getElementById("main").classList.toggle("expanded");
}

function toggleAvatarMenu(){
    const menu = document.getElementById("avatarMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function mostrarSelecaoPerfis(){
    document.getElementById("catalogo").style.display = "none";
    document.getElementById("selecaoPerfis").style.display = "flex";
}

function abrirConfiguracoes(){
    document.getElementById("configModal").style.display="flex";
}

function fecharConfig(){
    document.getElementById("configModal").style.display="none";
}

function mudarTema(theme){
    document.body.className = theme;
}

function mudarIdioma(){
    currentLanguage = document.getElementById("idiomaSelect").value;
    loadCategories();
}

async function hasTrailer(movieId) {
    try {
        const response = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=${currentLanguage}`);
        if (!response.ok) return false;

        const data = await response.json();
        const trailer = data.results?.find(video => video.type === "Trailer") || data.results?.[0];
        return !!trailer;
    } catch (error) {
        return false;
    }
}

async function loadFeaturedMoviesWithTrailers() {
    if (isLoadingFeatured) return;
    isLoadingFeatured = true;

    try {
        const response = await fetch(`https://api.themoviedb.org/3/movie/popular?api_key=${API_KEY}&language=${currentLanguage}&page=1`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        const popularMovies = data.results || [];

        featuredMoviesWithTrailers = [];

        const moviesToCheck = popularMovies.slice(0, 20);

        for (const movie of moviesToCheck) {
            if (await hasTrailer(movie.id)) {
                featuredMoviesWithTrailers.push(movie);
                if (featuredMoviesWithTrailers.length >= 10) break;
            }
        }

        if (featuredMoviesWithTrailers.length < 5) {
            const page2Response = await fetch(`https://api.themoviedb.org/3/movie/popular?api_key=${API_KEY}&language=${currentLanguage}&page=2`);
            if (page2Response.ok) {
                const page2Data = await page2Response.json();
                const page2Movies = page2Data.results || [];
                for (const movie of page2Movies.slice(0, 15)) {
                    if (featuredMoviesWithTrailers.length >= 10) break;
                    if (await hasTrailer(movie.id)) {
                        featuredMoviesWithTrailers.push(movie);
                    }
                }
            }
        }

        console.log(`Carregados ${featuredMoviesWithTrailers.length} filmes com trailers para o destaque`);

        if (featuredMoviesWithTrailers.length > 0) {
            showFeatured(0);
            startFeaturedRotation();
        } else {
            featuredMoviesWithTrailers = popularMovies.slice(0, 5);
            showFeatured(0);
            startFeaturedRotation();
        }

    } catch (error) {
        console.error("Erro ao carregar filmes em destaque:", error);
        document.getElementById("destaque-titulo").textContent = "Erro ao carregar filmes";
        document.getElementById("destaque-descricao").textContent = "Tente novamente mais tarde";
    }

    isLoadingFeatured = false;
}

async function loadCategories(){
    try {
        categories = movieCategories;
        moviesByCategory = {};

        const sidebar = document.getElementById("sidebar");
        sidebar.innerHTML = "<h2>Categorias</h2>";

        const allBtn = document.createElement("button");
        allBtn.textContent = "Todas";
        allBtn.classList.add("active");
        allBtn.onclick = () => showAllCategories();
        sidebar.appendChild(allBtn);

        categories.forEach(category => {
            const btn = document.createElement("button");
            btn.textContent = category.name;
            btn.onclick = (event) => filterByCategory(category.id, event);
            sidebar.appendChild(btn);
        });

        const main = document.getElementById("main");
        const existingCategories = main.querySelectorAll('.categoria');
        existingCategories.forEach(cat => cat.remove());

        loadFeaturedMoviesWithTrailers();

        for(const category of categories){
            await loadMovies(category.id, category.name);
        }

    } catch (error) {
        console.error("Erro ao carregar categorias:", error);
    }
}

async function loadMovies(categoryId, categoryName){
    try {
        const response = await fetch(`https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&language=${currentLanguage}&with_genres=${categoryId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        const movies = data.results || [];

        // Inserção do filme customizado
        if (categoryId === 99) {
            movies.unshift({
                id: "meu_doc",
                title: "Documentário JOÃOFLIX como foi criado",
                overview: "Um documentário especial criado por mim e exibido no Joãoflix.",
                poster_path: null,
                customPoster: "https://i.postimg.cc/fyh7SZdd/IMG-20250813-WA0006.jpg",
                customTrailer: "https://www.youtube.com/embed/VAeGrZyBV1c?si=LOMDX_Jc4R5qvYeF"
            });
        }

        moviesByCategory[categoryId] = movies;

        const main = document.getElementById("main");
        const categoryDiv = document.createElement("div");
        categoryDiv.classList.add("categoria");
        categoryDiv.id = `categoria-${categoryId}`;
        categoryDiv.innerHTML = `<h3>${categoryName}</h3><div class="scroll-horizontal"></div>`;
        main.appendChild(categoryDiv);

        const scrollDiv = categoryDiv.querySelector(".scroll-horizontal");
        movies.forEach(movie => {
            const card = document.createElement("div");
            card.classList.add("card-filme");
            const movieTitle = movie.title || movie.original_title || "Título não disponível";
            const movieOverview = movie.overview || "Descrição não disponível";
            const poster = movie.customPoster
                ? movie.customPoster
                : (movie.poster_path
                    ? IMG_BASE + movie.poster_path
                    : 'https://via.placeholder.com/160x240?text=Sem+Imagem');

            card.innerHTML = `
                <img src="${poster}" alt="${movieTitle}" onerror="this.src='https://via.placeholder.com/160x240?text=Sem+Imagem'">
                <div class="info">
                    <h4>${movieTitle}</h4>
                    <p>${movieOverview}</p>
                    <button class="btn-trailer" onclick="openTrailer('${movie.id}', '${movie.customTrailer || ''}')">▶ Trailer</button>
                </div>`;
            scrollDiv.appendChild(card);
        });
    } catch (error) {
        console.error("Erro ao carregar filmes:", error);
    }
}


function showAllCategories(){
    document.querySelectorAll(".categoria").forEach(category => {
        category.style.display = "block";
    });

    document.querySelectorAll(".sidebar button").forEach(btn => {
        btn.classList.remove("active");
    });

    document.querySelector(".sidebar button").classList.add("active");
}

function filterByCategory(categoryId, event){
    document.querySelectorAll(".categoria").forEach(category => {
        category.style.display = "block";
    });

    document.querySelectorAll(".sidebar button").forEach(btn => {
        btn.classList.remove("active");
    });

    if (event && event.target) {
        event.target.classList.add("active");
    }

    const targetCategory = document.getElementById(`categoria-${categoryId}`);
    if (targetCategory) {
        targetCategory.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }
}

// FUNÇÃO openTrailer CORRIGIDA: Suporta trailers customizados e busca trailers na API TMDB
async function openTrailer(movieId, customTrailer = "") {
    let trailerUrl = customTrailer;

    // Se não for um trailer customizado E não for o filme customizado ("meu_doc")
    if (!trailerUrl && movieId !== "meu_doc") {
        try {
            // Faz a chamada à API para obter os vídeos/trailers do filme
            const response = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=${currentLanguage}`);

            if (!response.ok) throw new Error("Erro ao buscar vídeos do TMDB.");

            const data = await response.json();
            // Busca o primeiro vídeo que seja um Trailer, ou o primeiro vídeo disponível, e que seja do YouTube
            const video = data.results?.find(v => v.type === "Trailer" && v.site === "YouTube") || data.results?.find(v => v.site === "YouTube");

            if (video && video.site === "YouTube") {
                // Constrói a URL do trailer usando a chave do YouTube
                trailerUrl = `https://www.youtube.com/embed/${video.key}`;
            } else {
                // Se não encontrou trailer no TMDB
                alert("Trailer não disponível para este título.");
                return;
            }
        } catch (error) {
            console.error("Erro ao carregar trailer:", error);
            alert("Erro ao carregar o trailer. Tente novamente mais tarde.");
            return;
        }
    }

    if (!trailerUrl) {
        alert("Trailer não disponível!");
        return;
    }

    // Monta a URL de embed final
    const embedUrl = trailerUrl.includes("youtube")
        ? trailerUrl.replace("watch?v=", "embed/").replace("?si=", "?autoplay=1&origin=*&si=")
        : trailerUrl;

    // Cria e exibe o overlay
    const overlay = document.createElement("div");
    overlay.id = "trailer-overlay";
    // As estilizações do overlay foram movidas para o CSS, mas podem ser mantidas aqui se preferir
    // Para fins deste script, apenas as linhas abaixo são realmente necessárias para o JS:
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.backgroundColor = "rgba(0,0,0,0.9)";
    overlay.style.display = "flex";
    overlay.style.justifyContent = "center";
    overlay.style.alignItems = "center";
    overlay.style.zIndex = 10000;


    overlay.innerHTML = `
        <iframe src="${embedUrl}"
                    style="width: 90%; max-width: 900px; height: 90%; max-height: 480px; border: none; border-radius: 8px;"
                    allow="autoplay; fullscreen; picture-in-picture"
                    allowfullscreen></iframe>
        <button style="position:absolute;top:20px;right:30px;font-size:30px;padding:5px 10px;background:#e50914;color:white;border:none;border-radius:6px;cursor:pointer;z-index:10001;" onclick="document.getElementById('trailer-overlay').remove()">×</button>
    `;

    document.body.appendChild(overlay);
}

// O restante das funções utilitárias:

function showFeatured(index){
    if(featuredMoviesWithTrailers.length === 0) return;

    featuredIndex = ((index % featuredMoviesWithTrailers.length) + featuredMoviesWithTrailers.length) % featuredMoviesWithTrailers.length;
    const featuredMovie = featuredMoviesWithTrailers[featuredIndex];

    if (featuredMovie) {
        const destaqueElement = document.getElementById("destaque");
        const backgroundImage = featuredMovie.backdrop_path ?
            `${IMG_BASE}${featuredMovie.backdrop_path}` :
            'https://via.placeholder.com/1920x1080?text=Sem+Imagem';

        destaqueElement.style.backgroundImage = `url(${backgroundImage})`;

        document.getElementById("destaque-titulo").textContent =
            featuredMovie.title || featuredMovie.original_title || "Título não disponível";
        document.getElementById("destaque-descricao").textContent =
            featuredMovie.overview || "Descrição não disponível";

        const btnTrailer = document.getElementById("btn-destaque-trailer");
        btnTrailer.onclick = () => openTrailer(featuredMovie.id);
        btnTrailer.setAttribute('data-movie-id', featuredMovie.id);
        btnTrailer.innerHTML = `▶ Assistir Trailer - ${featuredMovie.title || featuredMovie.original_title || "Filme"}`;
    }
}

function mudarDestaque(direction){
    if (featuredMoviesWithTrailers.length > 0) {
        showFeatured(featuredIndex + direction);
    }
}

function startFeaturedRotation(){
    if(featuredInterval) clearInterval(featuredInterval);
    if (featuredMoviesWithTrailers.length > 0) {
        featuredInterval = setInterval(() => mudarDestaque(1), 6000);
    }
}

function filtrarFilmes(){
    const searchTerm = document.getElementById("searchBar").value.toLowerCase();
    const destaqueElement = document.getElementById("destaque");

    destaqueElement.style.display = searchTerm ? "none" : "flex";

    document.querySelectorAll(".card-filme").forEach(card => {
        const titleElement = card.querySelector("h4");
        if (titleElement) {
            const movieTitle = titleElement.textContent.toLowerCase();
            card.style.display = movieTitle.includes(searchTerm) ? "flex" : "none";
        }
    });
}

function sair(){
    location.reload();
}

window.onload = () => {
    setTimeout(() => {
        const intro = document.querySelector(".intro");
        if (intro) {
            intro.style.display = "none";
        }
    }, 5000);

    const savedLanguage = "pt-BR";
    currentLanguage = savedLanguage;
    document.getElementById("idiomaSelect").value = currentLanguage;
};
